<html>
<head>

  <script src="js/gps.js" type="text/javascript" charset="utf-8" defer></script>
  <script src="js/compass.js" type="text/javascript" charset="utf-8" defer></script>

  <script src="js/pedometer.js" type="text/javascript" charset="utf-8" defer></script>
  <script src="js/podo.js" type="text/javascript" charset="utf-8" defer></script>
  <script type="text/javascript">
    var latitude, longitude;


    var app={};
    var podo;
    var compass;
    var gps;
    var pedometer;







    function requestMotionPermission(){
        try{


          DeviceMotionEvent.requestPermission()
          .then(response => {
              if (response == 'granted') {

                  window.addEventListener('devicemotion', (e) => {
                      // do something with e
                      motionEvent(e);

                  })
              }
          })
          .catch(console.error)
        } catch(err){
          console.log("no motion permission")
        }
    }

    function motionEvent(e){
      acceleration = e.accelerationIncludingGravity;
      document.getElementById("DeviceMotionMsg").innerHTML = "DeviceMotion";
      document.getElementById("accelX").innerHTML = acceleration.x;
      document.getElementById("accelY").innerHTML = acceleration.y;
      document.getElementById("accelZ").innerHTML = acceleration.z;

      if (app.activatePodo){
        if ((podo.acc_norm.length < 2) || (podo.stepArr.length < 2))
        {
          podo.createTable(Math.round(2/(event.interval/1000)));
        } else {
          norm = podo.computeNorm(e.accelerationIncludingGravity.x, e.accelerationIncludingGravity.y, e.accelerationIncludingGravity.z);
          podo.acc_norm.push(norm);

          podo.update();

          podo.onStep(podo.acc_norm);


          document.getElementById("acc_norm").innerHTML= podo.acc_norm;

          if (isNaN(podo.distance) == 0){
            document.getElementById("distance").innerHTML= Math.round(podo.distance/100) + "meters";
          } else {
            document.getElementById("distance").innerHTML=0;
          };

        };
      };
    }
    function init(){
      app.podo_stepSize = localStorage.podo_stepSize || 50;
      app.podo_weight = localStorage.podo_weight || 70;
    	app.podo_step = localStorage.podo_step || 0;
    	app.podo_speed = localStorage.podo_speed || 0;
    	app.podo_calory = localStorage.podo_calory || 0;
    	app.isGPSEnabled = localStorage.isGPSEnabled || false;

      podo = new PedometerORIG();
    	//init pedometer
    	podo.setCountStep(Math.round(app.podo_step));
    	podo.setWeight(Math.round(app.podo_weight));
    	podo.setStepSize(Math.round(app.podo_stepSize));
    	podo.setMeanSpeed(Math.round(app.podo_speed*1000.)/1000.);
    	podo.setCalory(Math.round(app.podo_calory*1000.)/1000.);
    	podo.setIsGPSEnabled(Boolean(app.isGPSEnabled));

    	app.activatePodo = 1;

      gps=new GPS();
      gps.init();
      gps.onChange=function(latitude, longitude, accuracy, timestamp){
        document.getElementById("lat").innerHTML = latitude;
        document.getElementById("lng").innerHTML = longitude;
      }
      gps.onError=function(type, message, error){
        console.log(type +" ERROR!" ,message, error);
      }

      requestMotionPermission();

      compass=new Compass();
      compass.init();
      compass.onError=function(type, message, error){
        console.log(type +" ERROR!" ,message, error);
      }
      compass.onChange=function(heading, cardinalDirection, interCardinalDirection){
        alert(heading);
        document.getElementById("heading").innerHTML = heading;
        document.getElementById("cardinalDirection").innerHTML = cardinalDirection;
        document.getElementById("interCardinalDirection").innerHTML = interCardinalDirection;
      }

      pedometer=new Pedometer();
      pedometer.init();
    }
  </script>
</head>

<body onload="init();">
  <h2>Device Location</h2>
  <table>
    <tr>
      <td>Lat</td>
      <td id="lat">-</td>
    </tr>

    <tr>
      <td>lng</td>
      <td id="lng">-</td>
    </tr>

  </table>
  <h2>Device Orientation</h2>
  <table>
    <tr>
      <td>Event Supported</td>
      <td id="DeviceOrientationMsg">-</td>
    </tr>
    <tr>
      <td>Tilt Left/Right [gamma]</td>
      <td id="doTiltLR">-</td>
    </tr>
    <tr>
      <td>Tilt Front/Back [beta]</td>
      <td id="doTiltFB">-</td>
    </tr>
    <tr>
      <td>Direction [alpha]</td>
      <td id="doDirection">-</td>
    </tr>
    <tr>
      <td>Heading</td>
      <td id="heading">-</td>
    </tr>
    <tr>
      <td>cardinalDirection</td>
      <td id="cardinalDirection">-</td>
    </tr>
    <tr>
      <td>interCardinalDirection</td>
      <td id="interCardinalDirection">-</td>
    </tr>

   </table>
  <h2>Device Motion</h2>
  <table>
    <tr>
      <td>Event Supported</td>
      <td id="DeviceMotionMsg">-</td>
    </tr>

    <tr>
      <td>accelX</td>
      <td id="accelX">-</td>
    </tr>
    <tr>
      <td>accelY</td>
      <td id="accelY">-</td>
    </tr>
    <tr>
      <td>accelZ</td>
      <td id="accelZ">-</td>
    </tr>
    <tr>
      <td>rotationRate</td>
      <td id="moRotation">-</td>
    </tr>
    <tr>
      <td>interval</td>
      <td id="moInterval">-</td>
    </tr>
    <tr>
      <td>acc_norm</td>
      <td id="acc_norm">-</td>
    </tr>
    <tr>
      <td>steps</td>
      <td id="steps">-</td>
    </tr>
    <tr>
      <td>distance</td>
      <td id="distance">-</td>
    </tr>

  </table>

</body>
</html>
